package org.example;

import java.rmi.server.ObjID;
import java.time.Instant;
import java.time.LocalDate;
import java.util.ArrayList;
import java.util.Scanner;
import java.util.concurrent.TimeUnit;
import java.util.prefs.Preferences;

import javax.print.Doc;

import org.bson.Document;
import org.bson.types.ObjectId;

import com.mongodb.client.MongoClient;
import com.mongodb.client.MongoClients;
import com.mongodb.client.MongoDatabase;
import com.mongodb.client.MongoCollection;

public class Main {

    public static String dbUri = "mongodb://localhost:27017";
    public static Preferences LocalStorage = Preferences.userNodeForPackage(Main.class);

    public static void createEvent() {
        Scanner sc = new Scanner(System.in);

        System.out.print("Enter a event title: ");
        String eventTitle = sc.nextLine();

        while (true) {
            LocalDate today = LocalDate.now();
            long timeNow = Instant.now().getEpochSecond();

            System.out.println("Enter Date and Time Accepted >= " + today);

            System.out.print("Enter The Year (Accepted 20XX): ");
            int year = sc.nextInt();

            System.out.print("Enter The Month (Accepted 1 - 12): ");
            int month = sc.nextInt();

            System.out.print("Enter The Day (Accepted: 1 - 31): ");
            int day = sc.nextInt();

            System.out.print("Enter The Hour (Accepted: 0 - 24): ");
            int hour = sc.nextInt();

            System.out.print("Enter The minutes (Accepted: 0 - 60): ");
            int minutes = sc.nextInt();

            String dateString = String.format("%04d-%02d-%02dT%02d:%02d:24.00Z", year, month, day, hour, minutes);

            System.out.println(dateString);

            long timeInSeconds = Instant.parse(dateString)
                    .getEpochSecond();

            if (timeInSeconds >= timeNow) {
                break;

            } else {

                System.out.println("Please Enter a Time and date thats >= " + today);
            }
        }

        System.out.print("Enter a location: ");
        String location = sc.nextLine();

        try (MongoClient mongoClient = MongoClients.create(dbUri)) {

            MongoDatabase db = mongoClient.getDatabase("event-manager");
            MongoCollection<Document> users = db.getCollection("users");

            ArrayList<Document> userQuery = new ArrayList<>();
            users.find().into(userQuery);
            sout
            System.out.println("[0] finished");

            for (int i = 0; i < userQuery.size(); i++) {
                Document user = userQuery.get(i);
                String username = user.getString("username");

                System.out.printf("[%d] %s\n", i + 1, username);
            }

            ArrayList<Document> requested = new ArrayList<>();

            int personIndex = 0;
            do {
                System.out.print("people you want to invite: ");
                personIndex = sc.nextInt();
                if(personIndex > 0)
                requested.add(userQuery.get(personIndex - 1));
            } while (personIndex != 0);

        }

    }

    public static void createUser() {
        Scanner sc = new Scanner(System.in);

        System.out.print("Enter a username: ");
        String userName = sc.nextLine();

        System.out.print("Enter a password: ");
        String password = sc.nextLine();

        System.out.print("confirm the password: ");
        String confirmPassword = sc.nextLine();

        if (!password.equals(confirmPassword)) {
            System.out.println("Password Confirmation is wrong please try again");
            createUser();
        }

        try (MongoClient mongoClient = MongoClients.create(dbUri)) {

            MongoDatabase db = mongoClient.getDatabase("event-manager");
            MongoCollection<Document> users = db.getCollection("users");

            Document existingUser = users.find(new Document("username", userName)).first();

            if (existingUser == null) {

                Document newUser = new Document("username", userName)
                        .append("password", password);

                users.insertOne(newUser);

                signin(newUser);
                mainMenu();

            } else {
                System.out.println("User already exists");
                ArrayList<String> options = new ArrayList<>();
                options.add("Try Again");
                options.add("Sign in instead");
                options.add("Back to main");

                int choice = getUserChoice(options);
                switch (choice) {
                    case 0:
                        createUser();
                        break;

                    case 1:
                        signin();
                        break;

                    case 2:
                        mainMenu();
                        break;

                    default:
                        break;
                }
            }

        }

    }

    public static void signin(Document user) {
        try (MongoClient mongoClient = MongoClients.create(dbUri)) {
            MongoDatabase db = mongoClient.getDatabase("event-manager");
            MongoCollection<Document> storage = db.getCollection("storage");

            long secondsSinceEpoch = Instant.now().getEpochSecond();

            String username = user.getString("username");
            Object userId = user.get("_id");

            Document session = new Document("username", username)
                    .append("time-created", secondsSinceEpoch)
                    .append("user-id", userId);

            storage.insertOne(session);

            LocalStorage.put("session", session.get("_id").toString());
        }
    }

    public static void signin() {

        Scanner sc = new Scanner(System.in);

        System.out.print("Enter a username: ");
        String userName = sc.nextLine();

        System.out.print("Enter a password: ");
        String password = sc.nextLine();

        try (MongoClient mongoClient = MongoClients.create(dbUri)) {

            MongoDatabase db = mongoClient.getDatabase("event-manager");
            MongoCollection<Document> users = db.getCollection("users");

            Document user = users.find(new Document("username", userName)).first();
            if (user != null) {
                String truePassword = user.getString("password");
                System.out.println(truePassword);
                System.out.println(password);
                if (password.equals(truePassword)) {

                    signin(user);
                    mainMenu();

                } else {

                    System.out.println("password doesn't match");
                    ArrayList<String> options = new ArrayList<>();
                    options.add("Try Again");
                    options.add("Create a user instead");
                    options.add("Back to main");

                    int choice = getUserChoice(options);
                    switch (choice) {
                        case 0:
                            signin();
                            break;

                        case 1:
                            createUser();
                            break;

                        case 2:
                            mainMenu();
                            break;

                        default:
                            break;

                    }

                }

            } else {

                System.out.println("user doesn't exit");

                ArrayList<String> options = new ArrayList<>();
                options.add("Try Again");
                options.add("Create a user instead");
                options.add("Back to main");

                int choice = getUserChoice(options);
                switch (choice) {
                    case 0:
                        signin();
                        break;

                    case 1:
                        createUser();
                        break;

                    case 2:
                        mainMenu();
                        break;

                    default:
                        break;
                }
            }

        }
    }

    public static int getUserChoice(ArrayList<String> options) {
        Scanner sc = new Scanner(System.in);
        int i = 0;

        for (; i < options.size(); i++) {
            System.out.printf("[%d] %s\n", i, options.get(i));
        }

        System.out.print("Your Choice: ");
        int choice = sc.nextInt();

        if (choice >= i) {
            System.out.println("Please enter a valid Entry");
            return getUserChoice(options);
        }
        return choice;
    }

    public static void logout(Document session) {
        try (MongoClient mongoClient = MongoClients.create(dbUri)) {

            MongoDatabase db = mongoClient.getDatabase("event-manager");
            MongoCollection<Document> storage = db.getCollection("storage");

            Object id = session.getObjectId("_id");
            if (id != null) {
                storage.deleteOne(new Document("_id", id));
                LocalStorage.remove("session");
            }

            mainMenu();
        }

    }

    public static void mainMenu() {
        Scanner sc = new Scanner(System.in);

        try (MongoClient mongoClient = MongoClients.create(dbUri)) {
            String sessionId = LocalStorage.get("session", null);

            if (sessionId == null) {
                ArrayList<String> options = new ArrayList<>();
                options.add("Create a user");
                options.add("Sign in");
                options.add("Exit");

                int choice = getUserChoice(options);

                switch (choice) {
                    case 0:
                        createUser();
                        break;

                    case 1:
                        signin();

                    default:
                        break;
                }

            } else {

                Object objId = new ObjectId(sessionId);
                System.out.println(sessionId);

                MongoDatabase db = mongoClient.getDatabase("event-manager");
                MongoCollection<Document> storage = db.getCollection("storage");

                Document session = storage.find(new Document("_id", objId)).first();
                System.out.println(session);
                long time = session.getLong("time-created");
                long secondsSinceEpoch = Instant.now().getEpochSecond();
                long duration = secondsSinceEpoch - time;
                long oneDayInSeconds = TimeUnit.DAYS.toSeconds(1);

                if (duration > oneDayInSeconds) {
                    logout(session);
                }

                ArrayList<String> options = new ArrayList<>();
                options.add("Create an Event");
                options.add("Log out");
                options.add("Exit");

                int choice = getUserChoice(options);

                switch (choice) {
                    case 0:
                        createEvent();
                        break;

                    case 1:
                        logout(session);
                        break;
                    case 2:
                        break;

                    default:
                        break;
                }

            }

        }
    }

    public static void main(String[] args) {
        mainMenu();
    }
}
